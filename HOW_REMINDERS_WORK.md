# ğŸ“‹ How Reminders Work in Your App

## ğŸ¯ Overview

Your app has a comprehensive reminder system that helps users track payments, bills, and custom reminders. Reminders are stored in the backend database and synced across devices.

## ğŸ“Š Reminder Types

### 1. **Custom Reminders** (Manual)
- Created by users manually
- Stored in backend database
- Can be marked as paid
- Synced across devices

### 2. **Auto-Generated Reminders**
- System-generated from recurring payments
- Created automatically based on payment templates
- Linked to payment sources

### 3. **Smart Reminders**
- Generated from transaction analysis
- Based on spending patterns
- Predictive reminders

## ğŸ—„ï¸ Database Structure

### Reminders Table Schema

```sql
CREATE TABLE reminders (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  type VARCHAR(50) DEFAULT 'general',
  due_date TIMESTAMP WITH TIME ZONE NOT NULL,
  reminder_time VARCHAR(10),
  priority VARCHAR(10) DEFAULT 'medium',
  category VARCHAR(100),
  source_type VARCHAR(50) DEFAULT 'manual',
  source_id VARCHAR(100),
  is_recurring BOOLEAN DEFAULT false,
  recurring_frequency VARCHAR(20),
  is_completed BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  is_enabled BOOLEAN DEFAULT true,
  repeat_type VARCHAR(20),
  amount DECIMAL(12,2),
  is_auto_generated BOOLEAN DEFAULT false,
  paid_at TIMESTAMP WITH TIME ZONE,  -- NEW: Tracks when reminder was paid
  created_at TIMESTAMP WITH TIME ZONE,
  updated_at TIMESTAMP WITH TIME ZONE
)
```

## ğŸ”„ How Reminders Flow

### **1. Creating a Reminder**

**Frontend (`RemindersScreen.tsx`):**
```typescript
// User fills form â†’ handleSaveReminder()
const newReminder: Reminder = {
  title: formData.title,
  description: formData.description,
  type: formData.type,
  dueDate: formData.date,
  time: formData.time,
  isEnabled: formData.isEnabled,
  repeat: formData.repeat,
  category: formData.category,
  amount: parseFloat(formData.amount) || 0,
  isAutoGenerated: false,
  // ... other fields
};

// Create via API
const result = await ReminderService.createReminder(newReminder);
```

**Service Layer (`ReminderService.ts`):**
```typescript
// Converts mobile format â†’ backend format
const backendReminder = {
  title: reminder.title,
  dueDate: dueDate.toISOString(),
  reminderTime: reminder.time.split(':').slice(0, 2).join(':'),
  // ... other fields
};

// POST to /api/reminders
const response = await authenticatedFetch(`${API_BASE_URL}/reminders`, {
  method: 'POST',
  body: JSON.stringify(backendReminder)
});
```

**Backend (`routes/reminders.ts`):**
```typescript
// Validates and saves to database
router.post('/', authenticateToken, [
  body('title').notEmpty(),
  body('dueDate').isISO8601(),
  // ... validation
], async (req, res) => {
  const result = await pool.query(
    'INSERT INTO reminders (...) VALUES (...) RETURNING *',
    [userId, title, dueDate, ...]
  );
  return res.json({ success: true, data: result.rows[0] });
});
```

### **2. Loading Reminders**

**On App Start / Screen Focus:**
```typescript
// RemindersScreen.tsx â†’ loadReminders()
const reminders = await ReminderService.getReminders();

// ReminderService.ts â†’ getReminders()
// GET /api/reminders
const response = await authenticatedFetch(`${API_BASE_URL}/reminders`);
const backendReminders = await response.json();

// Convert backend format â†’ mobile format
const reminders = backendReminders.data.map(backendReminder => ({
  id: backendReminder.id,
  title: backendReminder.title,
  dueDate: new Date(backendReminder.due_date),
  time: backendReminder.reminder_time,
  paidAt: backendReminder.paid_at ? new Date(backendReminder.paid_at) : undefined,
  // ... other fields
}));
```

### **3. Marking as Paid**

**User Action:**
```typescript
// RemindersScreen.tsx â†’ handleMarkAsPaid()
// Shows confirmation modal
setConfirmModalData({ reminder, daysUntilDue, type });
setShowConfirmModal(true);
```

**Confirmation:**
```typescript
// RemindersScreen.tsx â†’ confirmMarkAsPaid()
const paidAt = new Date();

// Update local state
setPaidItems(prev => ({
  ...prev,
  [reminder.id]: { type, reminder, paidAt }
}));

// Save to AsyncStorage (for offline access)
await savePaidItems(newPaidItems);

// Sync to backend (for custom reminders)
if (reminder.id && type === 'custom') {
  await ReminderService.updateReminder(reminder.id, { paidAt });
}

// Cancel notification
await cancelNotification(reminder.id);
```

**Backend Sync:**
```typescript
// ReminderService.ts â†’ updateReminder()
const backendUpdates = {
  paidAt: paidAt ? new Date(paidAt).toISOString() : null
};

// PUT /api/reminders/:id
await authenticatedFetch(`${API_BASE_URL}/reminders/${id}`, {
  method: 'PUT',
  body: JSON.stringify(backendUpdates)
});
```

**Backend Update:**
```typescript
// routes/reminders.ts â†’ PUT /api/reminders/:id
// Updates paid_at column in database
await pool.query(
  'UPDATE reminders SET paid_at = $1 WHERE id = $2',
  [paidAt, reminderId]
);
```

### **4. Reverting Payment**

**User Action:**
```typescript
// RemindersScreen.tsx â†’ revertPayment()
// Remove from paid items
setPaidItems(prev => {
  const newPaidItems = { ...prev };
  delete newPaidItems[reminder.id];
  return newPaidItems;
});

// Sync to backend (set paidAt to null)
if (reminder.id && type === 'custom') {
  await ReminderService.updateReminder(reminder.id, { paidAt: null });
}
```

## ğŸ”” Notification System

### **Scheduling Notifications**

```typescript
// RemindersScreen.tsx â†’ scheduleNotification()
const notificationId = await Notifications.scheduleNotificationAsync({
  content: {
    title: reminder.title,
    body: `Due on ${formatDate(reminder.dueDate)}`,
    data: { reminderId: reminder.id }
  },
  trigger: {
    date: new Date(reminder.dueDate),
    // ... repeat settings
  }
});

// Store notification ID for cancellation
await AsyncStorage.setItem(
  `notification_${reminder.id}`,
  notificationId.toString()
);
```

### **Canceling Notifications**

```typescript
// When reminder is marked as paid
const notificationId = await AsyncStorage.getItem(`notification_${reminder.id}`);
if (notificationId) {
  await Notifications.cancelScheduledNotificationAsync(notificationId);
  await AsyncStorage.removeItem(`notification_${reminder.id}`);
}
```

## ğŸ’¾ Data Storage

### **Backend (Primary Source)**
- PostgreSQL database
- All reminders stored in `reminders` table
- Synced across all user devices
- Includes `paid_at` field for payment tracking

### **Frontend (Cache)**
- AsyncStorage for offline access
- Cached reminders for quick loading
- Paid items stored locally for UI state
- Notifications scheduled locally

## ğŸ”„ Sync Flow

### **Cloud-First Approach**

1. **Primary Source:** Backend API
   - All CRUD operations go through API
   - Database is single source of truth

2. **Local Cache:** AsyncStorage
   - Cached for offline reference
   - Updated after API calls
   - Used for quick UI rendering

3. **Paid Status:**
   - Custom reminders: Synced to backend (`paid_at` column)
   - Auto-generated: Stored locally only
   - Merged on load: Backend data + local paid items

### **Load Process**

```typescript
// 1. Fetch from backend
const backendReminders = await ReminderService.getReminders();

// 2. Load local paid items
const localPaidItems = await loadPaidItems();

// 3. Merge paid status
const remindersWithPaidStatus = backendReminders.map(reminder => {
  const paidItem = localPaidItems[reminder.id];
  return {
    ...reminder,
    paidAt: paidItem?.paidAt || reminder.paidAt
  };
});
```

## ğŸ“± UI Features

### **Reminder Display**
- Grouped by type (Custom, Auto, Smart)
- Color-coded by urgency (overdue, due soon, upcoming)
- Shows days until due
- Displays amount if available

### **Actions**
- **Mark as Paid:** Updates backend + local storage
- **Revert Payment:** Removes paid status
- **Edit:** Updates reminder via API
- **Delete:** Removes from backend
- **Enable/Disable:** Toggles notification

## ğŸ” Security

- All API calls require authentication token
- User can only access their own reminders
- Backend validates user ownership
- Token refresh handled automatically

## ğŸš€ Recent Improvements

### **Paid Status Syncing** (Latest)
- Added `paid_at` column to database
- Custom reminders sync paid status to backend
- Persists across app reinstalls
- Migration: `20251118000000_add_reminder_paid_at.ts`

### **Session Persistence**
- Proactive token refresh
- Cached user data for instant UI
- Prevents data loss on token expiry

## ğŸ“Š Reminder States

1. **Active:** `is_active = true`, `is_enabled = true`
2. **Completed:** `is_completed = true`
3. **Paid:** `paid_at IS NOT NULL`
4. **Overdue:** `due_date < NOW()` and `paid_at IS NULL`
5. **Upcoming:** `due_date > NOW()` and `paid_at IS NULL`

## ğŸ¯ Key Files

- **Frontend:**
  - `ExpenseTrackerExpo/screens/RemindersScreen.tsx` - Main UI
  - `ExpenseTrackerExpo/services/ReminderService.ts` - API service
  - `ExpenseTrackerExpo/types/PaymentTypes.ts` - Type definitions

- **Backend:**
  - `backend-api/src/routes/reminders.ts` - API routes
  - `backend-api/src/migrations/20251118000000_add_reminder_paid_at.ts` - Paid status migration
  - `backend-api/src/config/database.ts` - Schema definition

